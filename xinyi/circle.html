<!DOCTYPE html>
<html>
<head>
<style>
    body { background-color: #1a1a1a; color: #ccc; font-family: sans-serif; display: flex; gap: 40px; padding: 50px; }
    .control-group { text-align: center; width: 100px; }
    .hidden-input { display: none; }

    .knob-wrapper {
        position: relative;
        width: 80px; height: 80px;
        margin: 0 auto 10px;
        cursor: pointer;
        user-select: none;
    }

    .knob-svg { transform: rotate(135deg); overflow: visible; }
    
    .track { fill: none; stroke: #333; stroke-width: 6; }
    
    .value-arc { 
        fill: none; stroke-width: 6; stroke-linecap: round;
        transition: stroke-dasharray 0.2s ease-out;
    }

    .pointer {
        stroke-width: 3; stroke-linecap: round;
        transform-origin: 40px 40px; /* 严格以圆心旋转 */
        transition: transform 0.2s ease-out;
    }

    #mKnob .value-arc, #mKnob .pointer { stroke: #ff4444; filter: drop-shadow(0 0 5px #ff4444); }
    #nKnob .value-arc, #nKnob .pointer { stroke: #ffcc00; filter: drop-shadow(0 0 5px #ffcc00); }
    #aKnob .value-arc, #aKnob .pointer { stroke: #00ffcc; filter: drop-shadow(0 0 5px #00ffcc); }

    .knob-label { font-size: 16px; font-weight: bold; margin-bottom: 15px; display: block; color: #fff; }
    .display-value { font-size: 14px; color: #888; margin-top: 10px; font-family: serif; }
</style>
</head>
<body>

    <div class="control-group">
        <label class="knob-label">m</label>
        <div class="knob-wrapper" id="mKnob">
            <svg class="knob-svg" width="80" height="80">
                <circle class="track" cx="40" cy="40" r="30" stroke-dasharray="141.4 188.5"></circle>
                <circle id="mArc" class="value-arc" cx="40" cy="40" r="30" stroke-dasharray="0 188.5"></circle>
                <line id="mPointer" class="pointer" x1="40" y1="40" x2="40" y2="10"></line>
            </svg>
            <input type="range" id="mSlider" min="1" max="16" step="1" value="8" class="hidden-input">
        </div>
        <div id="mVal" class="display-value">8</div>
    </div>

    <div class="control-group">
        <label class="knob-label">n</label>
        <div class="knob-wrapper" id="nKnob">
            <svg class="knob-svg" width="80" height="80">
                <circle class="track" cx="40" cy="40" r="30" stroke-dasharray="141.4 188.5"></circle>
                <circle id="nArc" class="value-arc" cx="40" cy="40" r="30" stroke-dasharray="0 188.5"></circle>
                <line id="nPointer" class="pointer" x1="40" y1="40" x2="40" y2="10"></line>
            </svg>
            <input type="range" id="nSlider" min="1" max="16" step="1" value="4" class="hidden-input">
        </div>
        <div id="nVal" class="display-value">4</div>
    </div>

    <div class="control-group">
        <label class="knob-label">a</label>
        <div class="knob-wrapper" id="aKnob">
            <svg class="knob-svg" width="80" height="80">
                <circle class="track" cx="40" cy="40" r="30" stroke-dasharray="141.4 188.5"></circle>
                <circle id="aArc" class="value-arc" cx="40" cy="40" r="30" stroke-dasharray="0 188.5"></circle>
                <line id="aPointer" class="pointer" x1="40" y1="40" x2="40" y2="10"></line>
            </svg>
            <input type="range" id="aSlider" min="-2" max="2" step="0.1" value="1" class="hidden-input">
        </div>
        <div id="aVal" class="display-value">1</div>
    </div>

<script>
function setupKnob(containerId, arcId, pointerId, inputId, valId) {
    const container = document.getElementById(containerId);
    const arc = document.getElementById(arcId);
    const pointer = document.getElementById(pointerId);
    const input = document.getElementById(inputId);
    const valDisplay = document.getElementById(valId);
    
    const circumference = 2 * Math.PI * 30;

    function updateUI(immediate = false) {
        const val = parseFloat(input.value);
        const percent = (val - input.min) / (input.max - input.min);
        
        // 如果是初始化，暂时禁用动画确保指向绝对精准
        if (immediate) {
            arc.style.transition = 'none';
            pointer.style.transition = 'none';
        } else {
            arc.style.transition = 'stroke-dasharray 0.2s ease-out';
            pointer.style.transition = 'transform 0.2s ease-out';
        }

        // 圆弧长度 (270度 = 0.75比例)
        const drawLength = percent * (circumference * 0.75);
        arc.style.strokeDasharray = `${drawLength} ${circumference}`;
        
        // 指针旋转 (0% -> 0deg, 100% -> 270deg)
        pointer.style.transform = `rotate(${percent * 270}deg)`;
        
        valDisplay.textContent = val;
        input.dispatchEvent(new Event('input'));
    }

    function handleInteraction(e) {
        const rect = container.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        let angle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
        let degrees = angle - 135; 
        while (degrees < 0) degrees += 360;

        if (degrees > 270) degrees = (degrees > 315) ? 0 : 270;

        const percent = degrees / 270;
        const rawValue = percent * (input.max - input.min) + parseFloat(input.min);
        const steppedValue = Math.round(rawValue / input.step) * input.step;
        
        input.value = steppedValue.toFixed(1); // 适配 a 旋钮的小数点
        updateUI();
    }

    let isDragging = false;
    container.addEventListener('mousedown', (e) => { isDragging = true; handleInteraction(e); });
    window.addEventListener('mousemove', (e) => { if (isDragging) handleInteraction(e); });
    window.addEventListener('mouseup', () => isDragging = false);

    // 初始同步
    updateUI(true);
}

// 启动所有旋钮
setupKnob('mKnob', 'mArc', 'mPointer', 'mSlider', 'mVal');
setupKnob('nKnob', 'nArc', 'nPointer', 'nSlider', 'nVal');
setupKnob('aKnob', 'aArc', 'aPointer', 'aSlider', 'aVal');
</script>
</body>
</html>